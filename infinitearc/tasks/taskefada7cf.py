# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-08
# ---------------------------------------------------------------

"""
Task ID: efada7cf
Difficulty: insane

=== Tags ===
- Shape extrusion
- Inverse rule reconstruction
- Remove thin noise
- Add corner markers

=== Description ===
**Task Name: Structural Extrusion with Noise Removal and Corner Marking**
**Description:**  Input grids feature multiple distinct, contiguous shapes
composed of non-background colors (1-9), each embedded within a background
(typically color 0). These shapes are often accompanied by thin, visually
insignificant noise elements—such as isolated single-pixel "stubs" or minimal-
length lines (1-2 pixels long) that extend from the main shape structure but
lack structural continuity. These noise elements appear as disconnected
fragments that do not contribute to the shape's overall form.  The
transformation requires three sequential, visually grounded steps:  1. **Remove
thin noise**: All pixels that are not part of a connected structural element
(i.e., pixels with fewer than two adjacent pixels of the same color in
horizontal or vertical directions) are eliminated. This step isolates the core
structural form of each shape, discarding artifacts like single-pixel
protrusions or isolated lines.  2. **Extrude shapes**: Each cleaned shape is
expanded outward by exactly one pixel in all four cardinal directions (up, down,
left, right), forming a uniform border around the original structure. Extrusion
is applied consistently to all shapes without overlapping or extending beyond
grid boundaries.  3. **Add corner markers**: For each extruded shape, the four
corners of its bounding box (the smallest rectangle enclosing the entire
extruded shape) are marked with distinct, consistent colors: top-left = color 9,
top-right = color 8, bottom-left = color 7, bottom-right = color 6. These
markers are placed precisely at the corner coordinates of the bounding box,
independent of the shape's internal structure.  The output grid retains the
background, displays all extruded shapes with their new borders, and includes
the corner markers at their designated positions. The task demands recognition
that noise removal is a prerequisite for accurate extrusion (a non-obvious
step), consistent application of structural expansion, and precise placement of
markers based on the final bounding geometry—requiring layered visual reasoning
to reconstruct the intended transformation rule from the input.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
import common

def generate():
    width = random.randint(6, 30)
    height = random.randint(6, 30)
    grid = [[0] * width for _ in range(height)]
    colors = random.sample(range(1, 10), random.randint(2, 4))
    for color in colors:
        shape_type = random.choice(['el', 'you', 'aitch'])
        pixels = common.rand_sprite(shape_type, random.randint(2, 5), random.randint(2, 5))
        offset_r = random.randint(0, height - 6)
        offset_c = random.randint(0, width - 6)
        for r, c in pixels:
            if 0 <= r + offset_r < height and 0 <= c + offset_c < width:
                grid[r + offset_r][c + offset_c] = color
    for r in range(height):
        for c in range(width):
            if grid[r][c] != 0:
                for dr, dc in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                    nr, nc = r + dr, c + dc
                    if 0 <= nr < height and 0 <= nc < width and grid[nr][nc] == 0:
                        if random.random() < 0.2:
                            grid[nr][nc] = grid[r][c]
    input_grid = [row[:] for row in grid]
    output_grid = noise_removal(input_grid)
    output_grid = extrude(output_grid)
    output_grid = add_corner_markers(output_grid)
    return {"input": input_grid, "output": output_grid}

def noise_removal(grid):
    rows = len(grid)
    cols = len(grid[0])
    new_grid = [row[:] for row in grid]
    for r in range(rows):
        for c in range(cols):
            if grid[r][c] == 0:
                continue
            count = 0
            for dr, dc in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                nr, nc = r + dr, c + dc
                if 0 <= nr < rows and 0 <= nc < cols and grid[nr][nc] == grid[r][c]:
                    count += 1
            if count < 2:
                new_grid[r][c] = 0
    return new_grid

def extrude(grid):
    rows = len(grid)
    cols = len(grid[0])
    new_grid = [row[:] for row in grid]
    for color in range(1, 10):
        pixels = []
        for r in range(rows):
            for c in range(cols):
                if grid[r][c] == color:
                    pixels.append((r, c))
        for r, c in pixels:
            for dr, dc in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                nr, nc = r + dr, c + dc
                if 0 <= nr < rows and 0 <= nc < cols and new_grid[nr][nc] == 0:
                    new_grid[nr][nc] = color
    return new_grid

def add_corner_markers(grid):
    rows = len(grid)
    cols = len(grid[0])
    for color in range(1, 10):
        pixels = []
        for r in range(rows):
            for c in range(cols):
                if grid[r][c] == color:
                    pixels.append((r, c))
        if not pixels:
            continue
        min_r = min(r for r, c in pixels)
        max_r = max(r for r, c in pixels)
        min_c = min(c for r, c in pixels)
        max_c = max(c for r, c in pixels)
        if min_r < max_r and min_c < max_c:
            grid[min_r][min_c] = 9
            grid[min_r][max_c] = 8
            grid[max_r][min_c] = 7
            grid[max_r][max_c] = 6
    return grid


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    # Ensure input is list of lists
    if isinstance(input_grid, tuple):
        input_grid = [list(row) for row in input_grid]
    elif isinstance(input_grid[0], tuple):
        input_grid = [list(row) for row in input_grid]
    
    def noise_removal(grid):
        rows = len(grid)
        cols = len(grid[0])
        new_grid = [row[:] for row in grid]
        for r in range(rows):
            for c in range(cols):
                if grid[r][c] == 0:
                    continue
                count = 0
                for dr, dc in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                    nr, nc = r + dr, c + dc
                    if 0 <= nr < rows and 0 <= nc < cols and grid[nr][nc] == grid[r][c]:
                        count += 1
                if count < 2:
                    new_grid[r][c] = 0
        return new_grid
    
    def extrude(grid):
        rows = len(grid)
        cols = len(grid[0])
        new_grid = [row[:] for row in grid]
        for color in range(1, 10):
            pixels = []
            for r in range(rows):
                for c in range(cols):
                    if grid[r][c] == color:
                        pixels.append((r, c))
            for r, c in pixels:
                for dr, dc in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                    nr, nc = r + dr, c + dc
                    if 0 <= nr < rows and 0 <= nc < cols and new_grid[nr][nc] == 0:
                        new_grid[nr][nc] = color
        return new_grid
    
    def add_corner_markers(grid):
        rows = len(grid)
        cols = len(grid[0])
        for color in range(1, 10):
            pixels = []
            for r in range(rows):
                for c in range(cols):
                    if grid[r][c] == color:
                        pixels.append((r, c))
            if not pixels:
                continue
            min_r = min(r for r, c in pixels)
            max_r = max(r for r, c in pixels)
            min_c = min(c for r, c in pixels)
            max_c = max(c for r, c in pixels)
            if min_r < max_r and min_c < max_c:
                grid[min_r][min_c] = 9
                grid[min_r][max_c] = 8
                grid[max_r][min_c] = 7
                grid[max_r][max_c] = 6
        return grid
    
    grid = noise_removal(input_grid)
    grid = extrude(grid)
    grid = add_corner_markers(grid)
    return grid
