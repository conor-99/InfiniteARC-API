# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-03
# ---------------------------------------------------------------

"""
Task ID: 5cc314df
Difficulty: insane

=== Tags ===
- Simulate gravity with obstacles
- Analogical goal mapping
- Ex nihilo

=== Description ===
Gravity-Driven Analogical Sculptures  Input grids are large (20×20 or larger)
with a uniform background color (0). Obstacles appear as non-overlapping
horizontal or vertical wall segments (color 1), each consisting of 2–5
contiguous cells. Falling objects are isolated colored blocks (colors 2–9)
positioned above obstacles or empty space, with no two blocks sharing the same
column. Gravity acts downward: each block falls vertically until it lands on a
wall, the grid bottom, or another settled block.  After gravity simulation, the
output grid incorporates two ex nihilo transformations based on analogical goal
mapping: 1. For every horizontal wall segment (row of contiguous color 1 cells),
generate a vertical column of color 2 blocks directly above the wall's midpoint.
The column extends upward from the wall's top edge for 2–3 cells, avoiding
existing obstacles. 2. For every vertical wall segment (column of contiguous
color 1 cells), generate a horizontal row of color 3 blocks directly to the left
of the wall's midpoint. The row extends leftward from the wall's left edge for
2–3 cells, avoiding existing obstacles.  The analogical mapping requires
recognizing wall orientation (horizontal/vertical) to determine the direction of
new element generation. The output visually represents both the gravity-
simulated block positions and the newly generated color 2/3 structures, forming
a cohesive pattern where the wall segments serve as templates for the analogical
sculptures. No input grid elements are overwritten during ex nihilo generation,
and all new elements occupy only background cells.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
from common import grid

def generate():
    width = random.randint(20, 30)
    height = random.randint(20, 30)
    input_grid = grid(width, height, 0)
    
    # Place horizontal walls
    num_horizontal = random.randint(3, 5)
    for _ in range(num_horizontal):
        row = random.randint(5, height - 6)
        start_col = random.randint(5, width - 6)
        length = random.randint(2, 5)
        for col in range(start_col, start_col + length):
            if col >= width: break
            input_grid[row][col] = 1
    
    # Place vertical walls
    num_vertical = random.randint(3, 5)
    for _ in range(num_vertical):
        col = random.randint(5, width - 6)
        start_row = random.randint(5, height - 6)
        length = random.randint(2, 5)
        for row in range(start_row, start_row + length):
            if row >= height: break
            input_grid[row][col] = 1
    
    # Place blocks
    for col in range(width):
        highest_wall_row = None
        for row in range(height):
            if input_grid[row][col] == 1:
                highest_wall_row = row
                break
        if highest_wall_row is not None and highest_wall_row > 0:
            input_grid[highest_wall_row - 1][col] = random.randint(2, 9)
    
    output_grid = [row[:] for row in input_grid]
    
    # Apply gravity
    for col in range(width):
        blocks = []
        for row in range(height - 1, -1, -1):
            if output_grid[row][col] in range(2, 10):
                blocks.append(row)
        blocks.sort(reverse=True)
        for row in blocks:
            current_row = row
            while current_row + 1 < height and output_grid[current_row + 1][col] == 0:
                current_row += 1
            output_grid[current_row][col] = output_grid[row][col]
            output_grid[row][col] = 0
    
    # Add color 2 structures for horizontal walls (2 cells)
    for row in range(height):
        col = 0
        while col < width:
            if output_grid[row][col] == 1:
                start_col = col
                while col < width and output_grid[row][col] == 1:
                    col += 1
                end_col = col - 1
                length = end_col - start_col + 1
                midpoint = start_col + length // 2
                for i in range(1, 3):  # Add 2 cells
                    new_row = row - i
                    if new_row < 0: break
                    if output_grid[new_row][midpoint] == 0:
                        output_grid[new_row][midpoint] = 2
                    else: break
            else:
                col += 1
    
    # Add color 3 structures for vertical walls (2 cells)
    for col in range(width):
        row = 0
        while row < height:
            if output_grid[row][col] == 1:
                start_row = row
                while row < height and output_grid[row][col] == 1:
                    row += 1
                end_row = row - 1
                length = end_row - start_row + 1
                midpoint = start_row + length // 2
                for i in range(1, 3):  # Add 2 cells
                    new_col = col - i
                    if new_col < 0: break
                    if output_grid[midpoint][new_col] == 0:
                        output_grid[midpoint][new_col] = 3
                    else: break
            else:
                row += 1
    
    return {
        "input": input_grid,
        "output": output_grid
    }


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

from common import grid

def p(input_grid):
    width = len(input_grid[0])
    height = len(input_grid)
    input_grid = [list(row) for row in input_grid]
    output_grid = [row[:] for row in input_grid]
    
    # Apply gravity
    for col in range(width):
        blocks = []
        for row in range(height - 1, -1, -1):
            if output_grid[row][col] in range(2, 10):
                blocks.append(row)
        blocks.sort(reverse=True)
        for row in blocks:
            current_row = row
            while current_row + 1 < height and output_grid[current_row + 1][col] == 0:
                current_row += 1
            output_grid[current_row][col] = output_grid[row][col]
            output_grid[row][col] = 0
    
    # Add color 2 structures for horizontal walls (2 cells)
    for row in range(height):
        col = 0
        while col < width:
            if output_grid[row][col] == 1:
                start_col = col
                while col < width and output_grid[row][col] == 1:
                    col += 1
                end_col = col - 1
                length = end_col - start_col + 1
                midpoint = start_col + length // 2
                for i in range(1, 3):
                    new_row = row - i
                    if new_row < 0: break
                    if output_grid[new_row][midpoint] == 0:
                        output_grid[new_row][midpoint] = 2
                    else: break
            else:
                col += 1
    
    # Add color 3 structures for vertical walls (2 cells)
    for col in range(width):
        row = 0
        while row < height:
            if output_grid[row][col] == 1:
                start_row = row
                while row < height and output_grid[row][col] == 1:
                    row += 1
                end_row = row - 1
                length = end_row - start_row + 1
                midpoint = start_row + length // 2
                for i in range(1, 3):
                    new_col = col - i
                    if new_col < 0: break
                    if output_grid[midpoint][new_col] == 0:
                        output_grid[midpoint][new_col] = 3
                    else: break
            else:
                row += 1
    
    return output_grid
