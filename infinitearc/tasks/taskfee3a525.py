# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-08
# ---------------------------------------------------------------

"""
Task ID: fee3a525
Difficulty: mediumâ€“hard

=== Tags ===
- Source target routing
- Context sensitive recolor
- Sand simulation
- Compose two transforms
- Color palette

=== Description ===
# Task Description: Sand Flow Recolor  This task requires transforming an input
grid into an output grid through two sequential, context-sensitive operations:
simulating vertical sand flow from sources to targets, followed by palette-based
recoloring of target cells. The input grid features a uniform background color
(0), with sources represented as isolated cells of color 1 positioned along the
top edge, and targets as scattered cells of colors 3, 4, or 5 distributed
throughout the grid. Targets are always positioned below sources with no
intervening non-background cells (ensuring direct vertical sand paths).  In the
first transformation, "sand" (represented as color 2) flows vertically downward
from each source until it encounters a target cell. The entire path from the
source to the target is filled with color 2, while the target cell remains
unchanged in this step. The sand path must be a straight vertical line with no
horizontal movement, and multiple sources may have overlapping paths that remain
distinct (as sand flows independently from each source).  In the second
transformation, each target cell undergoes context-sensitive recoloring based on
its original color, following a fixed palette mapping: color 3 becomes 4, color
4 becomes 5, and color 5 becomes 3. This recoloring occurs immediately after the
sand path is drawn, replacing the target's original color while leaving the sand
path (color 2) intact. The background (color 0) and all other non-target, non-
source cells remain unchanged throughout both transformations.  The output grid
must therefore show vertical sand paths (color 2) extending from all sources to
their respective targets, with each target cell now displaying its mapped color
from the palette. The task demands recognition of two distinct transformation
phases: the physical sand flow simulation and the conditional recoloring rule
based on target color context. The complexity arises from the need to apply both
operations sequentially while maintaining visual consistency across multiple
sources and targets with varying initial colors.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

def generate():
    import random
    from common import grid
    width = random.randint(2, 30)
    height = random.randint(2, 30)
    input_grid = grid(width, height, 0)
    num_sources = min(random.randint(1, 5), width)
    source_columns = random.sample(range(width), num_sources)
    target_info = []
    for c in source_columns:
        input_grid[0][c] = 1
        target_row = random.randint(1, height-1)
        target_color = random.choice([3,4,5])
        input_grid[target_row][c] = target_color
        target_info.append((c, target_row, target_color))
    output_grid = [row[:] for row in input_grid]
    for c, target_row, target_color in target_info:
        for r in range(0, target_row):
            output_grid[r][c] = 2
        if target_color == 3:
            output_grid[target_row][c] = 4
        elif target_color == 4:
            output_grid[target_row][c] = 5
        else:
            output_grid[target_row][c] = 3
    return {"input": input_grid, "output": output_grid}


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    grid = [list(row) for row in input_grid]
    height = len(grid)
    width = len(grid[0])
    for c in range(width):
        if grid[0][c] == 1:
            target_row = None
            for r in range(1, height):
                if grid[r][c] != 0:
                    target_row = r
                    break
            if target_row is None:
                continue
            for r in range(0, target_row):
                grid[r][c] = 2
            color = grid[target_row][c]
            if color == 3:
                grid[target_row][c] = 4
            elif color == 4:
                grid[target_row][c] = 5
            elif color == 5:
                grid[target_row][c] = 3
    return tuple(tuple(row) for row in grid)
