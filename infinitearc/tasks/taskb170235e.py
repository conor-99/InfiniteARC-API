# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-11
# ---------------------------------------------------------------

"""
Task ID: b170235e
Difficulty: insane

=== Tags ===
- Multi layer projection
- Coordinate system translation

=== Description ===
The input grid consists of multiple distinct colored layers, each defined by a
unique color (1–9) and containing an embedded coordinate system. Within each
layer, a vertical line (color 5) and horizontal line (color 6) intersect at a
point, forming a local origin. The vertical line may appear rotated within the
input grid, but its orientation relative to the grid axes determines the
required transformation.  The output grid is generated by rotating each layer to
align its vertical line (color 5) with the grid’s vertical axis and horizontal
line (color 6) with the grid’s horizontal axis. Rotations are restricted to 0°,
90°, 180°, or 270° to preserve grid structure. After alignment, all layers are
overlaid into a single grid, with overlapping cells colored according to
priority: higher-numbered colors (9 > 8 > ... > 1) override lower-numbered ones.
The background (color 0) remains unchanged in non-overlapping regions.  This
task demands identifying coordinate systems within complex, layered patterns,
determining precise rotation angles through spatial reasoning, and resolving
overlapping priorities—all while avoiding numerical computations and relying
solely on visual relationships. The input grids feature dense, interwoven layers
with ambiguous line orientations, requiring sequential analysis of multiple
coordinate systems to derive the correct output.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
from common import grid

def generate():
    width = random.randint(5, 30)
    height = random.randint(5, 30)
    input_grid = grid(width, height, 0)
    used_colors = set()
    num_layers = random.randint(2, 4)
    
    for _ in range(num_layers):
        c = random.choice([i for i in range(1, 10) if i not in used_colors])
        used_colors.add(c)
        rotation = random.choice([0, 90, 180, 270])
        x = random.randint(1, height-2)  # Row index (vertical)
        y = random.randint(1, width-2)   # Column index (horizontal)
        
        # Fill 3x3 area with layer color
        for dx in (-1, 0, 1):
            for dy in (-1, 0, 1):
                nx, ny = x + dx, y + dy
                if 0 <= nx < height and 0 <= ny < width:
                    input_grid[nx][ny] = c
        
        # Draw coordinate lines based on rotation
        if rotation in (0, 180):
            # Vertical line (color 5) - runs vertically (same column)
            for dx in (-1, 0, 1):
                nx = x + dx
                if 0 <= nx < height:
                    input_grid[nx][y] = 5
            # Horizontal line (color 6) - runs horizontally (same row)
            for dy in (-1, 0, 1):
                ny = y + dy
                if 0 <= ny < width:
                    input_grid[x][ny] = 6
        else:
            # Horizontal line (color 5) - runs horizontally (same row)
            for dy in (-1, 0, 1):
                ny = y + dy
                if 0 <= ny < width:
                    input_grid[x][ny] = 5
            # Vertical line (color 6) - runs vertically (same column)
            for dx in (-1, 0, 1):
                nx = x + dx
                if 0 <= nx < height:
                    input_grid[nx][y] = 6
    
    output_grid = grid(width, height, 0)
    for c in range(1, 10):
        if c == 5 or c == 6:
            continue
        layer_cells = []
        for i in range(height):
            for j in range(width):
                if input_grid[i][j] == c:
                    layer_cells.append((i, j))
        if not layer_cells:
            continue
        
        color5_cells = [cell for cell in layer_cells if input_grid[cell[0]][cell[1]] == 5]
        if not color5_cells:
            continue
        
        if all(cell[0] == color5_cells[0][0] for cell in color5_cells):
            rotation = 90
        else:
            rotation = 0
        
        min_i = min(cell[0] for cell in layer_cells)
        max_i = max(cell[0] for cell in layer_cells)
        min_j = min(cell[1] for cell in layer_cells)
        max_j = max(cell[1] for cell in layer_cells)
        
        region = []
        for i in range(min_i, max_i + 1):
            row = []
            for j in range(min_j, max_j + 1):
                row.append(input_grid[i][j])
            region.append(row)
        
        if rotation == 90:
            region = [list(x)[::-1] for x in zip(*region)]
        elif rotation == 180:
            region = [row[::-1] for row in region[::-1]]
        elif rotation == 270:
            region = list(zip(*region))[::-1]
        
        for i in range(len(region)):
            for j in range(len(region[0])):
                if region[i][j] != 0:
                    new_i = min_i + i
                    new_j = min_j + j
                    if 0 <= new_i < height and 0 <= new_j < width:
                        if region[i][j] > output_grid[new_i][new_j]:
                            output_grid[new_i][new_j] = region[i][j]
    
    return {'input': input_grid, 'output': output_grid}


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    width = len(input_grid[0])
    height = len(input_grid)
    output_grid = [[0] * width for _ in range(height)]
    
    for c in range(1, 10):
        if c == 5 or c == 6:
            continue
        layer_cells = []
        for i in range(height):
            for j in range(width):
                if input_grid[i][j] == c:
                    layer_cells.append((i, j))
        if not layer_cells:
            continue
        
        color5_cells = [cell for cell in layer_cells if input_grid[cell[0]][cell[1]] == 5]
        if not color5_cells:
            continue
        
        if all(cell[0] == color5_cells[0][0] for cell in color5_cells):
            rotation = 90
        else:
            rotation = 0
        
        min_i = min(cell[0] for cell in layer_cells)
        max_i = max(cell[0] for cell in layer_cells)
        min_j = min(cell[1] for cell in layer_cells)
        max_j = max(cell[1] for cell in layer_cells)
        
        region = []
        for i in range(min_i, max_i + 1):
            row = []
            for j in range(min_j, max_j + 1):
                row.append(input_grid[i][j])
            region.append(row)
        
        if rotation == 90:
            region = [list(x)[::-1] for x in zip(*region)]
        elif rotation == 180:
            region = [row[::-1] for row in region[::-1]]
        elif rotation == 270:
            region = list(zip(*region))[::-1]
        
        for i in range(len(region)):
            for j in range(len(region[0])):
                if region[i][j] != 0:
                    new_i = min_i + i
                    new_j = min_j + j
                    if 0 <= new_i < height and 0 <= new_j < width:
                        if region[i][j] > output_grid[new_i][new_j]:
                            output_grid[new_i][new_j] = region[i][j]
    
    return output_grid
