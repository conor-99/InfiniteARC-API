# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-04
# ---------------------------------------------------------------

"""
Task ID: a230672b
Difficulty: hard

=== Tags ===
- Variable binding by color
- Remove intruder

=== Description ===
The task involves transforming an input grid into an output grid by identifying
and removing "intruders" based on variable binding through color adjacency. The
input grid consists of a 2D array of integers (0–9), where 0 represents
background and non-zero values represent colors. The main structure in the grid
is formed by connected regions of multiple colors that are bound
together—specifically, each color region must have at least one adjacent pixel
of a different color (4-directionally connected). The intruder is defined as a
color region (connected component of a single non-zero color) where **no pixel
in the region is adjacent to a pixel of any other color**. Such isolated regions
are removed by setting all their pixels to 0 in the output grid. The
transformation requires identifying all connected components of non-zero colors,
verifying adjacency to other colors for each component, and eliminating the
isolated component(s). This rule is deterministic, compositional, and relies on
relational reasoning about color connectivity rather than memorization. The
difficulty arises from the need to correctly identify the isolated component(s)
within the structure, which may be subtle in larger or more complex grids.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import common
import random

def generate():
    w = random.randint(5, 30)
    h = random.randint(5, 30)
    color1 = common.random_color(exclude=[0])
    color2 = common.random_color(exclude=[0, color1])
    color3 = common.random_color(exclude=[0, color1, color2])
    
    input_grid = common.grid(w, h, 0)
    
    for c in range(w):
        input_grid[0][c] = color1
    
    for r in range(1, h):
        input_grid[r][0] = color2
    
    input_grid[h-1][w-1] = color3
    
    output_grid = [row[:] for row in input_grid]
    output_grid[h-1][w-1] = 0
    
    return {
        "input": input_grid,
        "output": output_grid
    }


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    # Ensure input_grid is list of lists
    if isinstance(input_grid[0], tuple):
        input_grid = [list(row) for row in input_grid]
    
    h = len(input_grid)
    w = len(input_grid[0])
    
    output_grid = [row[:] for row in input_grid]
    visited = [[False] * w for _ in range(h)]
    directions = [(1,0), (-1,0), (0,1), (0,-1)]
    
    for r in range(h):
        for c in range(w):
            if input_grid[r][c] > 0 and not visited[r][c]:
                color = input_grid[r][c]
                component = []
                queue = [(r, c)]
                visited[r][c] = True
                while queue:
                    cr, cc = queue.pop(0)
                    component.append((cr, cc))
                    for dr, dc in directions:
                        nr, nc = cr + dr, cc + dc
                        if 0 <= nr < h and 0 <= nc < w and not visited[nr][nc] and input_grid[nr][nc] == color:
                            visited[nr][nc] = True
                            queue.append((nr, nc))
                
                is_intruder = True
                for cr, cc in component:
                    for dr, dc in directions:
                        nr, nc = cr + dr, cc + dc
                        if 0 <= nr < h and 0 <= nc < w:
                            neighbor_color = input_grid[nr][nc]
                            if neighbor_color != 0 and neighbor_color != color:
                                is_intruder = False
                                break
                    if not is_intruder:
                        break
                
                if is_intruder:
                    for cr, cc in component:
                        output_grid[cr][cc] = 0
    
    return output_grid
