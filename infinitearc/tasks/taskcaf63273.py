# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-04
# ---------------------------------------------------------------

"""
Task ID: caf63273
Difficulty: very hard

=== Tags ===
- Pattern concatenation
- Impact highlight
- Multi exit routes
- Simulate gravity with obstacles

=== Description ===
Input grids feature a background (color 0), static obstacle blocks (color 1),
and movable impact sources (color 2) positioned above obstacles in their
columns. Each source falls vertically under gravity until colliding with the
first obstacle below it. Upon collision, the obstacle cell is highlighted (color
changed to 3), and the source is removed. The output grid displays all obstacles
that were impacted as highlighted (color 3), with sources removed. The sequence
of highlighted obstacle positions (ordered left-to-right across columns, and
top-to-bottom within each column) forms a horizontal "pattern concatenation"
that is embedded in the topmost row of the output grid. Each cell in this row
indicates the presence (color 3) or absence (color 0) of a highlight in its
corresponding column. "Multi exit routes" manifest through multiple independent
collision points across different columns, each contributing to the concatenated
pattern. "Impact highlight" refers to the color change of obstacles upon
collision, and "pattern concatenation" is the horizontal sequence of highlights
forming the top row.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
import common

def generate():
    width = random.randint(1, 30)
    height = random.randint(2, 30)
    input_grid = common.grid(width, height, 0)
    hits = [random.choice([True, False]) for _ in range(width)]
    if not any(hits):
        j = random.randint(0, width - 1)
        hits[j] = True
    for j in range(width):
        if hits[j]:
            i = random.randint(0, height - 2)
            input_grid[i][j] = 2
            input_grid[i+1][j] = 1
    output_grid = common.grid(width, height, 0)
    for j in range(width):
        output_grid[0][j] = 3 if hits[j] else 0
    for i in range(1, height):
        for j in range(width):
            if input_grid[i][j] == 2:
                output_grid[i][j] = 0
            elif input_grid[i][j] == 1 and hits[j]:
                output_grid[i][j] = 3
            else:
                output_grid[i][j] = input_grid[i][j]
    return {
        "input": input_grid,
        "output": output_grid
    }


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    height = len(input_grid)
    width = len(input_grid[0])
    hits = [False] * width
    for j in range(width):
        for i in range(height):
            if input_grid[i][j] == 2:
                for k in range(i+1, height):
                    if input_grid[k][j] == 1:
                        hits[j] = True
                        break
                break
    output_grid = [[0] * width for _ in range(height)]
    for j in range(width):
        output_grid[0][j] = 3 if hits[j] else 0
    for i in range(1, height):
        for j in range(width):
            if input_grid[i][j] == 2:
                output_grid[i][j] = 0
            elif input_grid[i][j] == 1 and hits[j]:
                output_grid[i][j] = 3
            else:
                output_grid[i][j] = input_grid[i][j]
    return output_grid
