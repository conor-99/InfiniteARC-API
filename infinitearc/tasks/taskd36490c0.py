# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-09
# ---------------------------------------------------------------

"""
Task ID: d36490c0
Difficulty: hard

=== Tags ===
- Refraction simulation

=== Description ===
Input grids feature a background color (0) and a continuous beam path (single
non-background color) starting from one grid edge and moving straight. The grid
contains scattered cells of colors 1-9 (refraction media), each inducing a
specific directional change upon beam entry. When the beam enters a media cell,
its direction changes relative to current movement: color 1 causes a 45° left
turn, color 2 a 45° right turn, color 3 a 90° left turn, color 4 a 90° right
turn, color 5 a 135° left turn, color 6 a 135° right turn, color 7 a 180° turn
(reversing direction), color 8 a 225° left turn, and color 9 a 225° right turn.
The beam's color updates to match the media cell's color upon entry. The beam
continues moving in the new direction until it exits the grid or encounters
another media cell. Output grids display the full refracted trajectory with
color changes reflecting the last media cell entered, showing the beam's path
after all directional transformations. The beam never overwrites media cells or
background, and all paths are guaranteed to exit within finite steps.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
from common import grid, all_pixels

def generate():
    width = random.randint(10, 30)
    height = random.randint(10, 30)
    input_grid = grid(width, height, 0)
    start_row = random.randint(0, height - 1)
    
    # Place straight beam path (color 5)
    for c in range(width):
        input_grid[start_row][c] = 5
        
    # Place media cells (1-9) at random positions along path
    media_positions = []
    num_media = random.randint(1, 3)
    for _ in range(num_media):
        c = random.randint(1, width - 2)
        color = random.randint(1, 9)
        input_grid[start_row][c] = color
        media_positions.append((start_row, c))

    # Generate output grid by simulating refraction
    output_grid = grid(width, height, 0)
    current_dir = (0, 1)  # east
    current_color = 5
    current_pos = (start_row, 0)
    
    while True:
        r, c = current_pos
        output_grid[r][c] = current_color
        
        next_r = r + current_dir[0]
        next_c = c + current_dir[1]
        if not (0 <= next_r < height and 0 <= next_c < width):
            break
        
        if input_grid[next_r][next_c] != 0 and input_grid[next_r][next_c] != 5:
            media_color = input_grid[next_r][next_c]
            current_color = media_color
            
            # Calculate new direction
            dr, dc = current_dir
            if media_color == 1:
                current_dir = (-dc, dr)
            elif media_color == 2:
                current_dir = (dc, -dr)
            elif media_color == 3:
                current_dir = (-dc, dr)
            elif media_color == 4:
                current_dir = (dc, -dr)
            elif media_color == 5:
                current_dir = (-dr, -dc)
            elif media_color == 6:
                current_dir = (dr, dc)
            elif media_color == 7:
                current_dir = (-dr, -dc)
            elif media_color == 8:
                current_dir = (dr, dc)
            elif media_color == 9:
                current_dir = (-dr, -dc)
        
        current_pos = (next_r, next_c)
    
    return {
        "input": input_grid,
        "output": output_grid
    }


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

from common import grid

def p(input_grid):
    width = len(input_grid[0])
    height = len(input_grid)
    input_grid = [list(row) for row in input_grid]
    
    # Find start position (left edge, column 0)
    start_row = None
    for r in range(height):
        if input_grid[r][0] != 0:
            start_row = r
            break
    if start_row is None:
        return input_grid

    # Simulate refraction path
    output_grid = grid(width, height, 0)
    current_dir = (0, 1)  # east
    current_color = 5
    current_pos = (start_row, 0)
    
    while True:
        r, c = current_pos
        output_grid[r][c] = current_color
        
        next_r = r + current_dir[0]
        next_c = c + current_dir[1]
        if not (0 <= next_r < height and 0 <= next_c < width):
            break
        
        if input_grid[next_r][next_c] != 0 and input_grid[next_r][next_c] != 5:
            media_color = input_grid[next_r][next_c]
            current_color = media_color
            
            dr, dc = current_dir
            if media_color == 1:
                current_dir = (-dc, dr)
            elif media_color == 2:
                current_dir = (dc, -dr)
            elif media_color == 3:
                current_dir = (-dc, dr)
            elif media_color == 4:
                current_dir = (dc, -dr)
            elif media_color == 5:
                current_dir = (-dr, -dc)
            elif media_color == 6:
                current_dir = (dr, dc)
            elif media_color == 7:
                current_dir = (-dr, -dc)
            elif media_color == 8:
                current_dir = (dr, dc)
            elif media_color == 9:
                current_dir = (-dr, -dc)
        
        current_pos = (next_r, next_c)
    
    return output_grid
