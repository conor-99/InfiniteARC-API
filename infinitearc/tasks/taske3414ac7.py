# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-06
# ---------------------------------------------------------------

"""
Task ID: e3414ac7
Difficulty: insane

=== Tags ===
- Count hor lines
- Execute grid based program
- Portals
- Parse and render drawing commands

=== Description ===
The input grid features a visual composition where specific colors encode
distinct elements: color 4 denotes horizontal line segments, color 5 marks
portal entrances, color 6 marks portal exits, and column 0 (starting at row 1)
encodes directional commands (1=up, 2=right, 3=down, 4=left). The task requires
first counting all contiguous horizontal segments of color 4 in any row to
determine the iteration count N. Next, the directional command sequence is
parsed from column 0, row 1 onward. Portal pairs (color 5 and color 6) are
sequentially paired in row-major order. The drawing process begins at (0,0),
executing the command sequence N times: each step moves the cursor in the
specified direction, teleporting to the corresponding portal exit upon
encountering a color 5 cell. The output grid renders the cumulative path of all
movements (including teleports) as color 9, with all other cells set to the
background color. For "insane" difficulty, grids contain ≥3 horizontal segments
(N≥3), extended command sequences (≥8 directions), overlapping portal pairs, and
paths requiring multi-step teleportation logic, demanding precise sequential
reasoning across complex spatial relationships.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

def generate():
    import random
    width = random.randint(9, 30)
    height = random.randint(9, 30)
    grid = [[0] * width for _ in range(height)]
    n_segments = random.randint(3, 5)
    for _ in range(n_segments):
        r = random.randint(0, height-1)
        start = random.randint(0, width-2)
        end = random.randint(start+1, width-1)
        for c in range(start, end+1):
            grid[r][c] = 4
    num_pairs = random.randint(2, 3)
    for _ in range(num_pairs):
        r5, c5 = random.randint(0, height-1), random.randint(1, width-1)
        grid[r5][c5] = 5
    for _ in range(num_pairs):
        r6, c6 = random.randint(0, height-1), random.randint(1, width-1)
        grid[r6][c6] = 6
    commands = [random.randint(1, 4) for _ in range(height-1)]
    for r in range(1, height):
        grid[r][0] = commands[r-1]
    n = 0
    for row in grid:
        i = 0
        while i < width:
            if row[i] == 4:
                n += 1
                while i < width and row[i] == 4:
                    i += 1
            else:
                i += 1
    cmd_list = [grid[r][0] for r in range(1, height)]
    portals_5 = []
    portals_6 = []
    for r in range(height):
        for c in range(width):
            if grid[r][c] == 5:
                portals_5.append((r, c))
            elif grid[r][c] == 6:
                portals_6.append((r, c))
    portal_pairs = list(zip(portals_5, portals_6))
    output = [[0] * width for _ in range(height)]
    r, c = 0, 0
    output[r][c] = 9
    for step in range(n):
        cmd = cmd_list[step % len(cmd_list)]
        dr, dc = 0, 0
        if cmd == 1: dr = -1
        elif cmd == 2: dc = 1
        elif cmd == 3: dr = 1
        elif cmd == 4: dc = -1
        nr = r + dr
        nc = c + dc
        if grid[nr][nc] == 5:
            for (entrance, exit) in portal_pairs:
                if (nr, nc) == entrance:
                    nr, nc = exit
                    break
        output[nr][nc] = 9
        r, c = nr, nc
    return {"input": grid, "output": output}


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    height = len(input_grid)
    width = len(input_grid[0])
    n = 0
    for row in input_grid:
        i = 0
        while i < width:
            if row[i] == 4:
                n += 1
                while i < width and row[i] == 4:
                    i += 1
            else:
                i += 1
    commands = [input_grid[r][0] for r in range(1, height)]
    portals_5 = []
    portals_6 = []
    for r in range(height):
        for c in range(width):
            if input_grid[r][c] == 5:
                portals_5.append((r, c))
            elif input_grid[r][c] == 6:
                portals_6.append((r, c))
    portal_pairs = list(zip(portals_5, portals_6))
    output = [[0] * width for _ in range(height)]
    r, c = 0, 0
    output[r][c] = 9
    for step in range(n):
        cmd = commands[step % len(commands)]
        dr, dc = 0, 0
        if cmd == 1: dr = -1
        elif cmd == 2: dc = 1
        elif cmd == 3: dr = 1
        elif cmd == 4: dc = -1
        nr = r + dr
        nc = c + dc
        if input_grid[nr][nc] == 5:
            for (entrance, exit) in portal_pairs:
                if (nr, nc) == entrance:
                    nr, nc = exit
                    break
        output[nr][nc] = 9
        r, c = nr, nc
    return output
