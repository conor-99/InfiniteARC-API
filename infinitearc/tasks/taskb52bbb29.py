# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-07
# ---------------------------------------------------------------

"""
Task ID: b52bbb29
Difficulty: hard

=== Tags ===
- Gravity with barriers
- Guided flow
- Field based motion
- Remove noise
- Bounce

=== Description ===
Input grids are large (minimum 20×20) with a single background color (0). They
contain solid barriers (colors 1-4 representing distinct barrier types:
1=horizontal walls, 2=vertical walls, 3=corner barriers, 4=diagonal barriers),
flow sources (color 5 positioned along the top edge), guided flow elements
(color 6 acting as directional fields), and noise cells (colors 7-9 scattered
throughout). Barriers are placed such that they form non-overlapping paths with
at least one valid flow route from each source.  The transformation process
involves: 1. **Noise removal**: All noise cells (colors 7-9) are replaced with
background color (0). 2. **Flow initiation**: Each flow source (color 5) begins
a path moving downward (gravity direction). 3. **Barrier interaction**: When a
flow encounters a barrier:    - Horizontal barrier (color 1) reverses horizontal
movement direction.    - Vertical barrier (color 2) reverses vertical movement
direction.    - Corner barrier (color 3) changes direction by 90 degrees.    -
Diagonal barrier (color 4) reflects path like a diagonal mirror. 4. **Guided
flow**: Upon encountering a color 6 cell, the flow turns left or right based on
the field's orientation, overriding gravity direction. 5. **Path drawing**: The
flow path is drawn in color 3 over background cells (0), never overwriting
barriers or noise. Paths terminate when exiting the grid, with no intersections
or overlaps.  The output grid preserves all barriers and guided flow elements
unchanged, removes all noise, and displays the complete flow paths as continuous
color 3 lines following the described physics rules.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random

def generate():
    size = random.randint(20, 30)
    grid = [[0] * size for _ in range(size)]
    
    # Place horizontal barriers (type 1)
    for _ in range(random.randint(2, 5)):
        row = random.randint(1, size-2)
        start_col = random.randint(5, size-10)
        length = random.randint(3, 5)
        for c in range(start_col, start_col + length):
            if grid[row][c] == 0:
                grid[row][c] = 1

    # Place vertical barriers (type 2)
    for _ in range(random.randint(2, 5)):
        col = random.randint(5, size-2)
        start_row = random.randint(1, size-10)
        length = random.randint(3, 5)
        for r in range(start_row, start_row + length):
            if grid[r][col] == 0:
                grid[r][col] = 2

    # Place corner barrier (type 3)
    if random.random() > 0.5:
        r, c = random.randint(10, size-10), random.randint(10, size-10)
        if grid[r][c] == 0:
            grid[r][c] = 3

    # Place diagonal barriers (type 4)
    if random.random() > 0.5:
        start = random.randint(5, size-10)
        for i in range(start, min(start+5, size-5)):
            r, c = i, i
            if r < size and c < size and grid[r][c] == 0:
                grid[r][c] = 4

    # Place flow sources (color 5) on top row
    for c in range(5, size-5):
        if random.random() > 0.7 and grid[0][c] == 0:
            grid[0][c] = 5

    # Place guided flow (color 6)
    for _ in range(random.randint(3, 6)):
        r, c = random.randint(1, size-2), random.randint(5, size-5)
        if grid[r][c] == 0:
            grid[r][c] = 6

    # Place noise (colors 7-9)
    for r in range(size):
        for c in range(size):
            if random.random() > 0.8 and grid[r][c] == 0:
                grid[r][c] = random.randint(7, 9)

    # Create output by simulating flow paths
    output = [row[:] for row in grid]
    
    # Remove noise (7-9 → 0)
    for r in range(size):
        for c in range(size):
            if output[r][c] in (7, 8, 9):
                output[r][c] = 0

    # Simulate flow paths for each source
    for c in range(size):
        if grid[0][c] == 5:
            r, dr, dc = 1, 1, 0
            while 0 <= r < size and 0 <= c < size:
                cell_val = grid[r][c]
                
                if cell_val == 1:  # Horizontal barrier
                    dr, dc = -dr, dc
                elif cell_val == 2:  # Vertical barrier
                    dr, dc = dr, -dc
                elif cell_val == 3:  # Corner barrier
                    if dr == 1: dr, dc = 0, 1
                    elif dc == 1: dr, dc = -1, 0
                    elif dr == -1: dr, dc = 0, -1
                    elif dc == -1: dr, dc = 1, 0
                elif cell_val == 4:  # Diagonal barrier
                    dr, dc = -dr, -dc
                elif cell_val == 6:  # Guided flow
                    if dr == 1: dr, dc = 0, 1
                    elif dc == 1: dr, dc = -1, 0
                    elif dr == -1: dr, dc = 0, -1
                    elif dc == -1: dr, dc = 1, 0

                if output[r][c] == 0:
                    output[r][c] = 3

                r += dr
                c += dc

    return {"input": grid, "output": output}


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    size = len(input_grid)
    grid = [list(row) for row in input_grid]
    output = [row[:] for row in grid]
    
    for r in range(size):
        for c in range(size):
            if output[r][c] in (7, 8, 9):
                output[r][c] = 0

    for c in range(size):
        if grid[0][c] == 5:
            r, dr, dc = 1, 1, 0
            while 0 <= r < size and 0 <= c < size:
                cell_val = grid[r][c]
                
                if cell_val == 1:
                    dr, dc = -dr, dc
                elif cell_val == 2:
                    dr, dc = dr, -dc
                elif cell_val == 3:
                    if dr == 1: dr, dc = 0, 1
                    elif dc == 1: dr, dc = -1, 0
                    elif dr == -1: dr, dc = 0, -1
                    elif dc == -1: dr, dc = 1, 0
                elif cell_val == 4:
                    dr, dc = -dr, -dc
                elif cell_val == 6:
                    if dr == 1: dr, dc = 0, 1
                    elif dc == 1: dr, dc = -1, 0
                    elif dr == -1: dr, dc = 0, -1
                    elif dc == -1: dr, dc = 1, 0

                if output[r][c] == 0:
                    output[r][c] = 3

                r += dr
                c += dc

    return output
