# ---------------------------------------------------------------
# This file was automatically generated. DO NOT EDIT MANUALLY.
# 
# Generated by: conor-99/InfiniteARC/prepare.py
# Date: 2025-11-09
# ---------------------------------------------------------------

"""
Task ID: 1ad7efe5
Difficulty: very hard

=== Tags ===
- Heat map draw
- Wave reflection
- Remove intruder
- Find shape in negative space

=== Description ===
Input grids are large (20x20 or larger) with a uniform background color (0).
Walls (color 1) form interconnected orthogonal corridors without touching,
creating a maze-like structure. Wave sources (color 2) are positioned along the
top edge, emitting rays that travel rightward. Intruders—non-rectangular
clusters of colors 3-9 (e.g., L-shapes, T-shapes)—are placed throughout the
grid, overlapping only background cells and never walls or sources. The negative
space (background) contains a hidden square shape (3x3) that is entirely
obscured by intruders.  In the output grid: 1. Walls (color 1) remain unchanged.
2. Wave rays propagate rightward until hitting walls, reflecting with direction
changes (vertical walls reverse horizontal direction, horizontal walls reverse
vertical direction). Each reflection increments the ray color (starting at 3,
then 4, 5, etc.). 3. All intruders (colors 3-9) are removed (set to background
0). 4. The hidden 3x3 square (previously covered by intruders) is highlighted
with a fixed color (5), revealing the "shape in negative space" as the only
visible geometric form in the background.  The task requires simultaneously
tracking wave reflection physics, identifying and removing intruders, and
recognizing the geometric pattern in the background after intruder removal—all
while ensuring wave paths do not intersect and reflection sequences follow a
consistent color progression.
"""


# ---------------------------------------------------------------
# Generator Code
# ---------------------------------------------------------------

import random
from common import grid

def generate():
    width = random.randint(20, 30)
    height = random.randint(20, 30)
    input_grid = grid(width, height, 0)
    
    # Generate maze-like walls
    for col in range(5, width-5, 5):
        for row in range(5, height-5):
            if random.random() > 0.5:
                input_grid[row][col] = 1
    
    # Place wave sources on top edge
    sources = []
    for col in range(1, width-1):
        if input_grid[0][col] == 0:
            input_grid[0][col] = 2
            sources.append(col)
    
    # Find hidden 3x3 square
    r, c = random.randint(5, height-8), random.randint(5, width-8)
    for dr in range(3):
        for dc in range(3):
            input_grid[r+dr][c+dc] = random.randint(3, 9)
    
    # Create output grid
    output_grid = [row[:] for row in input_grid]
    
    # Remove intruders
    for dr in range(3):
        for dc in range(3):
            output_grid[r+dr][c+dc] = 0
    
    # Highlight hidden square
    for dr in range(3):
        for dc in range(3):
            output_grid[r+dr][c+dc] = 5
    
    # Simulate wave paths
    for col in sources:
        r, c = 0, col
        direction = (0, 1)
        current_color = 3
        while True:
            nr, nc = r + direction[0], c + direction[1]
            if not (0 <= nr < height and 0 <= nc < width):
                break
            if input_grid[nr][nc] == 1:
                direction = (-direction[0], -direction[1])
                current_color += 1
            else:
                output_grid[nr][nc] = current_color
                r, c = nr, nc
    
    return {'input': input_grid, 'output': output_grid}


# ---------------------------------------------------------------
# Solver Code
# ---------------------------------------------------------------

def p(input_grid):
    input_list = [list(row) for row in input_grid]
    height = len(input_list)
    width = len(input_list[0])
    output = [row[:] for row in input_list]
    
    # Remove intruders
    for r in range(height):
        for c in range(width):
            if output[r][c] >= 3:
                output[r][c] = 0
    
    # Find hidden square
    hidden_square = None
    for r in range(height - 2):
        for c in range(width - 2):
            if all(input_list[r+dr][c+dc] >= 3 for dr in range(3) for dc in range(3)):
                hidden_square = (r, c)
                break
        if hidden_square:
            break
    
    if hidden_square:
        r0, c0 = hidden_square
        for dr in range(3):
            for dc in range(3):
                output[r0+dr][c0+dc] = 5
    
    # Simulate waves
    for c in range(width):
        if input_list[0][c] == 2:
            r, col = 0, c
            direction = (0, 1)
            current_color = 3
            while True:
                nr, nc = r + direction[0], col + direction[1]
                if not (0 <= nr < height and 0 <= nc < width):
                    break
                if input_list[nr][nc] == 1:
                    direction = (-direction[0], -direction[1])
                    current_color += 1
                else:
                    output[nr][nc] = current_color
                    r, col = nr, nc
    
    return tuple(tuple(row) for row in output)
